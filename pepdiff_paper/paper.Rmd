---
title: "pepdiff: An R package for differential abundance analysis of factorial phosphoproteomics experiments"
author: "Dan MacLean, The Sainsbury Laboratory, Norwich Research Park, Norwich NR4 7UH, UK"
abstract: |
  pepdiff is an R package for differential abundance analysis of factorial proteomics experiments. The package uses Gamma generalised linear models with emmeans-based contrasts to accommodate the right-skewed distributions and systematic missingness characteristic of proteomics data. A simple interface enables stratified comparisons that capture effects within factor levels without requiring manual contrast specification. Alternative methods include the Aligned Rank Transform for non-parametric analysis and pairwise tests for simple two-group comparisons. Built-in diagnostics guide method selection. pepdiff is freely available from GitHub (https://github.com/TeamMacLean/pepdiff) with documentation at https://teammaclean.github.io/pepdiff/.
bibliography: references.bib
output:
  pdf_document:
    keep_tex: true
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Introduction

Phosphoproteomics experiments commonly employ factorial designs---treatment crossed with timepoint, genotype crossed with condition---to characterise how cellular signalling responds to perturbation over time [@olsen2006phosphoproteomics; @humphrey2015phosphoproteomics]. Analysis of such experiments should respect their factorial structure; when treatment effects vary across timepoints, stratified comparisons at each timepoint can be more informative than pooled comparisons that average across the design.

Proteomics data present specific analytical challenges. Abundance values are right-skewed and strictly positive, variance typically scales with the mean, and missing values are often systematic rather than random---low-abundance peptides are more likely to be missing [@webb2015mnar; @lazar2016mnar]. Standard analysis workflows that log-transform data and impute missing values may introduce bias, particularly when missingness is informative.

Existing tools support factorial analysis of proteomics data. Perseus [@tyanova2016perseus], MSstats [@choi2014msstats], and limma [@ritchie2015limma] can all accommodate factorial designs with appropriate configuration. However, specifying design matrices and contrast codes requires statistical expertise that may not be available in all research groups. In practice, many analyses default to simpler pairwise comparisons.

pepdiff provides an accessible interface to factorial proteomics analysis. Users specify which factor to contrast and which factor to stratify by; the package handles contrast specification automatically. The underlying statistical methods---Gamma generalised linear models with emmeans contrasts [@lenth2022emmeans]---are established approaches applied through a simplified interface. pepdiff complements the companion package peppwR [@maclean2026peppwr] for power analysis: peppwR addresses experimental design ("How many samples do I need?") while pepdiff addresses data analysis ("What's differentially abundant?").

# Implementation

pepdiff provides a workflow from data import through analysis to visualisation. Users import data from CSV files, specifying columns for peptide identifiers, gene annotations, abundance values, experimental factors, and replicate structure. The package validates the experimental design, assesses missingness patterns, and summarises the factorial structure. Two S3 classes---`pepdiff_data` for imported data and `pepdiff_results` for analysis output---provide consistent print, summary, and plot methods.

The primary analytical approach fits Gamma generalised linear models to each peptide independently. The Gamma distribution naturally accommodates right-skewed, strictly positive abundance values, while the log link models multiplicative treatment effects [@mccullagh1989glm]. This approach analyses available observations rather than imputing missing values, avoiding potential bias from imputation when missingness is non-random. Contrasts are extracted using the emmeans package [@lenth2022emmeans], which computes estimated marginal means and pairwise differences with appropriate standard errors.

Stratification is specified through a simple interface: the `compare` parameter indicates which factor to contrast, `ref` specifies the reference level, and `within` specifies the stratifying factor. This produces separate contrasts at each level of the stratifying factor. For example, contrasting treatment within timepoint produces treatment effects at 0h, 6h, and 24h separately. A formula interface accommodates more complex contrast specifications for users requiring custom comparisons.

When model diagnostics indicate poor fit, alternative methods are available. The Aligned Rank Transform (ART) method [@wobbrock2011art] provides a non-parametric alternative that preserves factorial structure while relaxing distributional assumptions. Four pairwise tests---Wilcoxon rank-sum [@wilcoxon1945], bootstrap-t [@efron1993bootstrap], Bayes factor [@rouder2009bayest], and rank products [@breitling2004rankprod]---are available for simple two-group comparisons without factorial structure, matching the tests available in peppwR for workflow consistency.

Built-in diagnostics guide method selection. A four-panel diagnostic plot assesses GLM fit across peptides, displaying deviance distributions and QQ plots of standardised residuals. Peptides with elevated deviance, indicating potentially violated assumptions, are flagged for consideration of alternative methods. Benjamini-Hochberg false discovery rate correction [@benjamini1995fdr] is applied within each comparison.

# Example Applications

## Factorial Design

To evaluate pepdiff with known ground truth, we simulated a factorial phosphoproteomics experiment (full code in Supplementary Material). The design crossed treatment (control, drug) with timepoint (0h, 6h, 24h) using six biological replicates per condition. Of 500 peptides, 50 had a true treatment effect (3--5 fold change) that manifested only at 24 hours, simulating a delayed drug response. Approximately 8% of observations were missing with a pattern biased toward low abundances.

We analysed these data using four approaches (Table 1). pepdiff's stratified GLM---contrasting treatment within each timepoint---detected 46 of 50 true positives at the 24-hour timepoint with one false positive (sensitivity 0.92, FDR 0.02). The 0h and 6h timepoints showed near-zero significant peptides, as expected given the simulation design.

For comparison, we applied a conventional proteomics workflow typical of tools like Perseus [@tyanova2016perseus] to the 24-hour timepoint: log2-transform abundances, impute missing values using a downshifted normal distribution, and apply t-tests with FDR correction. This approach detected 42 of 50 true positives (sensitivity 0.84, FDR 0.02). Analysing only peptides with complete observations at 24 hours detected 37 true positives (sensitivity 0.74, FDR 0.03), with the reduction attributable to excluding peptides with missing data.

We also tested a comparison that pooled observations across all timepoints, ignoring when measurements were taken. This analysis detected no significant peptides. Because effects existed only at 24 hours in this simulation, the signal from the 24-hour timepoint was diluted by the null observations at 0h and 6h. This result illustrates the importance of matching analysis to experimental design rather than reflecting general inadequacy of pooled approaches.

| Approach | Sensitivity | FDR (observed) | Note |
|----------|-------------|----------------|------|
| Stratified GLM (pepdiff) | 0.92 | 0.02 | Analyses each timepoint separately |
| Log2 + impute + t-test (Perseus) | 0.84 | 0.02 | Requires selecting correct timepoint |
| Complete cases only | 0.74 | 0.03 | Excludes peptides with missing data |
| Pooled across timepoints | 0.00 | â€” | Signal diluted by null timepoints |

Table: Method comparison at 24-hour timepoint. Sensitivity is TP/(TP+FN); FDR (observed) is the proportion of detected positives that were false (FP/(TP+FP)), calculated against simulation ground truth. All methods used FDR < 0.05 as the significance threshold. The pooled result reflects the simulation design where effects occur only at 24 hours.

Figure 1 illustrates the value of stratified analysis. Volcano plots at each timepoint (panel A) show that treatment effects emerge specifically at 24 hours, with no significant differences at 0h or 6h. Panel B shows the 24-hour results annotated with ground truth, confirming that pepdiff correctly identifies true positives while controlling false discoveries.

## Pairwise Design

pepdiff also supports simple two-group comparisons without factorial structure. We simulated 200 peptides comparing control versus treatment with 8 replicates per group. Of these, 30 peptides had true effects (2--4 fold change). Using the Wilcoxon rank-sum test (`method = "pairwise", test = "wilcoxon"`), pepdiff detected 26 of 30 true positives with 2 false positives (sensitivity 0.87, FDR 0.07). The bootstrap-t test produced similar results (sensitivity 0.83, FDR 0.04). Full details are provided in the Supplementary Material.

![Figure 1. Stratified analysis captures timepoint-specific effects. (A) Volcano plots of treatment effects at each timepoint show significant differences only at 24 hours, where true effects were simulated. Dashed line indicates FDR = 0.05. (B) The 24-hour volcano plot annotated with ground truth: red points are true positives (46/50 detected), blue points are false negatives (4/50 missed), and grey points are true negatives. One false positive was detected.](figure_1.pdf)

# Discussion

pepdiff simplifies stratified factorial analysis for proteomics experiments by automating contrast specification. The package uses established statistical methods---Gamma GLMs with emmeans contrasts---through an interface that does not require users to manually code design matrices. Results are comparable to careful manual analysis; the primary benefit is accessibility rather than statistical novelty.

Our simulations illustrate the value of matching analysis to experimental design. In the factorial example, stratified analysis captured timepoint-specific effects, while pooled analysis did not detect significant differences because effects were present at only one timepoint. The conventional workflow achieved similar sensitivity to pepdiff when applied to the correct timepoint, though this required prior knowledge of when to look. In practice, stratified analysis examines all timepoints simultaneously without requiring such knowledge.

Several limitations apply. pepdiff models each peptide independently without borrowing information across peptides, unlike hierarchical approaches in tools such as limma. The package assumes cross-sectional factorial designs with independent biological replicates; longitudinal studies with repeated measures require different methods. The Gamma GLM assumes positive, continuous abundance values; spectral counts or binary presence/absence data require alternative approaches.

pepdiff, together with peppwR for power analysis, provides a workflow for factorial phosphoproteomics experiments from experimental design through differential abundance analysis.

# Funding

This work was supported by the Gatsby Charitable Foundation.

# References
